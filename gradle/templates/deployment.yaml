apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    name: {{ .Values.app_name }}
    revision: {{ .Chart.Version | replace "+" "_"  }}
  name: {{ .Values.app_name  }}
spec:
  selector:
    matchLabels:
      app: {{ .Values.app_name  }}
  replicas: {{ .Values.deployment.replicas | default 1 }}
  template:
    metadata:
      annotations: 
        sidecar.istio.io/inject: "{{ .Values.deployment.istio_inject | default true }}"
      labels:
        app: {{ .Values.app_name }}
    spec:
      # serviceAccountName: {{ .Values.deployment.serviceAccount | default "fabric8-service-account" }}
      securityContext:
        fsGroup: 1000
      containers:
        - name: {{ .Values.app_name  }}
          image: {{ .Values.deployment.image.name }}
          imagePullPolicy: {{ .Values.deployment.image.pullPolicy }}
          command: ["/bin/bash","-c","{{ .Values.deployment.image.command  | default "dotnet ${DLL_NAME:-`ls|grep runtimeconfig.json|awk -F. '{print $1}'`}.dll" }}" ]
          env:
          - name: CLUSTER_NAME
            value: {{.Values.platform.cd.cluster}}
          {{- range $key, $val := .Values.deployment.env }}
          - name: {{ $key }}
            value: {{ $val | quote}}
          {{- end }}
          {{- if .Values.secret }}
          envFrom:
            - secretRef:
                name: {{ .Values.app_name }}
          {{- end }}
          ports:
          {{- range $key, $val := .Values.service.ports }}
          - containerPort: {{ $val }}
          {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          {{- $http_port := .Values.service.ports.http }}
          {{- with .Values.deployment.liveness }}
          livenessProbe:
            httpGet:
              path: {{ .path }}
              port: {{ $http_port }}
            failureThreshold: {{ .failure_threshold | default 15}}
            successThreshold: {{ .success_threshold | default 1 }}
            timeoutSeconds: {{ .timeout_seconds | default 1 }}
            initialDelaySeconds: {{ .initial_delay_seconds | default 10 }}
            periodSeconds: {{ .period_seconds | default 5 }}
          {{- end }}
          {{- with .Values.deployment.readiness }}
          readinessProbe:
            httpGet:
              path: {{ .path }}
              port: {{ $http_port }}
            failureThreshold: {{ .failure_threshold | default 15}}
            successThreshold: {{ .success_threshold | default 1 }}
            timeoutSeconds: {{ .timeout_seconds | default 1 }}
            initialDelaySeconds: {{ .initial_delay_seconds | default 10 }}
            periodSeconds: {{ .period_seconds | default 5 }}
          {{- end }}